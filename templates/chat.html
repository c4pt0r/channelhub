<!doctype html>
<html>
<link rel='stylesheet' href='/static/scrollbar.css' type='text/css' media='screen' />

<style> 
 body, html {
 	margin: 0;
 	padding: 0;
 	font-family: Arial, Helvetica;
    overflow:hidden;
 }
 textarea { 
    overflow: auto;
    margin: 5px; 
    height:100%;
    border: none;
    padding: 2px;
  }

  .header {
    background-color: #2d2d2d;
    border-bottom: 1px solid #000;
    height: 25px;
  	padding: 5px;
    padding-left: 10px;
    color: #fff;
    line-height: 25px;
  }
  .bottom {
  	height: 100px;
  	text-align: center;
  	border-top: 1px solid #ccc;
  }

  .scroll-container {
  	background: #fff;
  	color: #333;
  	padding:5px;
  	overflow: auto;
  }

  .text-container {
  	float: left;
    width:100%;
  }
  .online-user-container {
  	width: 180px;
  	float: right;
  }

  .text-item {
  	margin-bottom: 10px;
  }
  .boldtext {
  	font-weight: bolder;
  }

  .body-contrainer {
  	width: 100%;
  }
  .body-contrainer td{
  	vertical-align: top;
    padding-right:10px;
  }
  .user-item {
  	margin-bottom: 5px;
  }
  .user-item img{
   	position:relative;
  	top:4px;
  }
  .user-item span {
   	padding-left: 5px;
  }
  .user-item .writting-status {
  	font-size: 10px;
  	color: #aaa;
  	position:relative;
  	top:-2px;
  }
</style>
	<body>
		<div class="container">
			<div class="header">
                #{{.ChannelName}}
			</div>
			<table class="body-contrainer" >
				<tr>
					<td width="80%">
						<div class="scroll-container text-container">
						</div>
					</td>
					<td width="20%">
						<div class="scroll-container online-user-container online-user">
						</div>
					</td>
				</tr>
			</table> 
			<div class="bottom">
				<textarea autofocus></textarea>
			</div>
		</div>

	</body>
    <script src="http://a.tbcdn.cn/libs/jquery/1.7.1/jquery.js"></script>
    <script src="/static/underscore-min.js"></script>
    <script>
	  $(document).ready(function (){
              function onsize() {
                  $("textarea").width($(window).width() - 14)
                  $(".scroll-container").height($(window).height() - 170)
              }
              onsize()
              $(window).resize(function() {
                  onsize()
              })

              var userItemTemplate = _.template(' <div class="user-item" id="<%=name%>"><img src="<%=pic%>" width=20 height=20/><span><%=name%></span></div>');
              var textItemTemplate = _.template('<div class="text-item admin"> <span class="boldtext"><%=sender%></span> : <%=content%> </div>')

              var addOnlineUser = function (usr) {
                $('.online-user').prepend(userItemTemplate({name:usr["user"].split('@')[0], pic:usr["pic"]}))
              }

              var addTextItem = function (textObj) {
                $('.text-container').append(textItemTemplate(textObj))
              }

              var removeOnlineUser = function (usr) {
                $('#' + usr['user'].split('@')[0]).remove()
              }

              // web socket connection
              if (window["WebSocket"]) {
                conn = new WebSocket("ws://{{.Host}}/{{.ChannelName}}/ws");

                conn.onclose = function (evt) {
                  console.log("connection closed")
                }
                conn.onmessage = function (evt) {
                  var msg = eval('[' + evt.data + ']')[0]
                  
                  if (msg['type'] == 'text') {
                    addTextItem(msg)
                  } else if (msg['type'] == 'adduser') {
                    var obj = JSON.parse(msg['content'])
                    addOnlineUser(obj)
                  } else if (msg['type'] == 'removeuser') {
                    var obj = JSON.parse(msg['content'])
                    removeOnlineUser(obj)
                  }
                }
                conn.onopen = function(evt) {
                    getOnlineUsers(function (data) {
                        for (var i = 0 ; i < data.length; i++) {
                            addOnlineUser(data[i])
                        }
                    })
                }
              }

              var getOnlineUsers = function(f){
                    // get online user list
                    $.get('/{{.ChannelName}}/online', function(data) {
                        f(data)
                    })
              }
              
              for (var i = 0; i < 100; i++) {
                addTextItem({sender:'c4pt0r', content:'hello'})
              }
            })
	</script>
</html>
